%  Emacs    : -*- latex -*-
%  File     : design.tex
%  RCS      : $Id: design.tex,v 1.14 2008/11/19 22:50:59 schachte Exp $
%  Author   : Peter Schachte
%  Origin   : Fri Mar 28 19:36:48 2003
%  Purpose  : Discussion document on design of new language
%  Copyright: © 2003 Peter Schachte.  All rights reserved.
%

\documentclass{article}
\usepackage{a4wide}
\usepackage{xspace}
\usepackage{fancyvrb}
%\usepackage{ensuremath}

\newcommand{\lang}{\textsc{Wybe}\xspace}
\newcommand{\Lang}{\textsc{Wybe}\xspace}

\newcommand{\ie}{\emph{i.e.}\xspace}
\newcommand{\eg}{\emph{e.g.}\xspace}
\newcommand{\Ie}{\emph{I.e.}\xspace}
\newcommand{\Eg}{\emph{E.g.}\xspace}
\newcommand{\etc}{\emph{etc}}

\newcommand{\tuple}[1]{\ensuremath{\langle#1\rangle}}

\title{The \Lang Programming Language}
\author{Peter Schachte}

\begin{document}
\maketitle

\section{Aims}

The aim of this project is to produce a clean, easy-to-learn,
easy-to-use programming language suitable for large teams to produce
maintainable programs.  It should be suitable as a first programming
language, and should be powerful and efficient enough for serious use.


\section{Explicit dataflow indicators}

In \Lang, each variable use may either read, write, or modify
(\ie, both read and write) the variable.
Variable names prefixed with a \verb+^+ operator specify that the
variable will be written (without being read); variable names prefixed
with a \verb+!+ operator signify that it will be read and written.
Unadorned variable names indicate read-only usage.



\section{Functions and procedures}

\Lang supports both functions and procedures.
The top level of a procedure definition, and the top level of a
module, are statement contexts.
Calls written there are taken to be procedure calls.
The arguments of a procedure or function call, and the body of a
function definition, are expressions.
Calls written as parts of expressions are taken to be function calls.

However, procedures and functions are, in fact, the same thing called
with a different syntax.
A function call is merely a procedure call whose final
argument is omitted; the value of that argument after the call is
taken to be the value of the function call.
A procedure call is merely a function call with one extra argument
whose value is the value of the function call.
So regardless of whether something is defined as procedure or
function, it may be called as either an expression or a statement.

Each procedure argument, may be input, output, or both, according
to the \verb+^+ and \verb+!+ annotations on its declaration.
A particular ordering of inputs, outputs, and in/out arguments is
called a procedure \emph{mode}.
A given procedure name may have any number of different declarations
with the same argument types and different modes, but may not have
more than one declaration with the same types and modes.
There are some restrictions on modes specific to functions:
\begin{enumerate}
\item if the last argument is output, at least one other argument must
  be input; and
\item if the last argument is input, at least one other argument must
  be output or in/out; and
\item the last argument must not be in/out.
\end{enumerate}
If any of these restrictions are not met, the procedure cannot be used
with a functional syntax in that mode.
These restrictions are imposed to ensure functional syntax is only
used for procedures that behave functionally.


\section{Syntax}

The new syntax philosophy is conceptual parsimony, built on relatively
few syntactic elements.

Miscellaneous ideas:
\begin{itemize}
\item Special syntax for manifest constant maps:
  \begin{center}
  \texttt{\{}\textit{key$_1$}\texttt{::}\textit{value$_1$},
  \textit{key$_2$}\texttt{::}\textit{value$_2$}, \ldots\texttt{\}}
  \end{center}
  As a special case, sets can be written as
  \begin{center}
  \texttt{\{}\textit{key$_1$}, \textit{key$_2$}, \ldots\texttt{\}}
  \end{center}

\item Allow use of ``\verb`|`'' as an alternative to ``\verb`,`'' to
  separate set and map items.
  When values involve multiple statements, this is useful because \verb`|`
  has lower precedence than statement separation.
  If ``\verb`|`'' is the first or last thing within curly braces, it is
  ignored, to simplify code layout and avoid the separator vs.\ terminator
  problem.
  

\item Capitalising on this, we use this syntax for case statements:
  \begin{center}
    \texttt{case} \textit{expr} \textit{map}
  \end{center}
  where the values in the \textit{map} are statement sequences. Case
  expressions are similar, but where the values in the \textit{map} are
  expressions.

  One challenge to this is that we want case values to be patterns, which
  can have outputs. This makes maps quite powerful, as matching keys must
  involve pattern matching, \ie, executing code.
  Is this too powerful?

\item Conditional statements and expressions have the syntax
  \begin{center}
    \texttt{if} \textit{map}
  \end{center}
  which is equivalent to \texttt{case true} \textit{map}. For this to be
  meaningful, the semantics of manifest constants maps must be that
  multiple mappings with identical keys are permitted, and the \emph{first}
  mapping for the repeated key is taken.

\item Allow a set of statement sequences to be treated as a closure?
  A singleton set is a deterministic statement sequence (providing its
  statements are det), and multi-element sets are nondet, so ``\verb`|`''
  could be used to separate alternatives in generators.
  This would allow curly brace notation for statement sequences, but
  int means that where a statement sequence is used, it needs to be
  surrounded by braces.
  Perhaps we could coerce a single statement to a singleton statement
  sequence.

\item Either maintain the decision not to have any statement separators, or
  allow separator (semicolon, I assume) to be omitted when its the last
  thing on a line.

\item As a special syntactic case, allow proc calls with a single argument
  to be written without the parentheses surrounding the argument (or with
  them).

\end{itemize}



At the highest (tightest) precedence, \lang has manifest constants, identifiers,
and calls.  A call is written as an identifier followed by an open
parenthesis, a comma-separated argument list, and a close parenthesis.

\textbf{Abandon this:}
At the loosest precedence, \lang supports ``interfix'' operators:
alternating identifiers and terms of higher precedence.  These are
parsed as a term whose constructor is the concatenation of the
identifiers, separated by underscores, with the subterms, in order, as
arguments.


\subsubsection*{Definition}
\begin{Verbatim}
    def foo(x:int, y:int) use io {
        !bar(x)
        !baz(y)
    }
\end{Verbatim}

\begin{Verbatim}
    def hypot(x:int, y:int):int = sqrt(x**2 + y**2)
\end{Verbatim}

\subsubsection*{Selection}
\begin{Verbatim}
        if {
        | prime(x):
            !bar(x)
            !baz(y)
        | else:
            !baz(y)
            !bar(x)
        }
\end{Verbatim}

\begin{Verbatim}
        case x {
        | 0:: !bar(x)
              !baz(y)
        | 1:: !baz(y)
              !bar(x)
        | _:: nop
        }

\end{Verbatim}

\subsubsection*{Looping}
\begin{Verbatim}
        do {stmt1
            while test
            stmt2
        }
\end{Verbatim}


\Lang procedure and function names can be used as prefix or infix
operators, regardless of whether they are alphabetic or symbolic.
Their precedence and associativity are determined by the first
character of the operator name, as follows:
\begin{center}
  \begin{tabular}{|c|c|c|c|}
    \hline
    \textbf{lead character} &
    \textbf{arity} &
    \textbf{associativity} &
    \textbf{precedence} \\
    \hline
    \verb'.' (period) &
    infix &
    left &
    10 (tightest) \\
    \hline
    \verb'^', \verb'!' &
    unary (prefix) &
    non-associative &
    9 \\
    \hline
    \verb'~', \verb'@', \verb'$', \verb'%', \verb'&', \verb'=',
    \verb'*', \verb'/', \verb'-', \verb'+' &
    unary (prefix) &
    non-associative &
    8 \\
    \hline
    \verb'*', \verb'/', \verb'%' &
    binary (infix) &
    left &
    7 \\
    \hline
    \verb'-', \verb'+' &
    binary (infix) &
    left &
    6 \\
    \hline
    \verb':' &
    binary (infix) &
    non-associative &
    5 \\
    \hline
    \verb'a'--\verb'z', \verb'A'--\verb'Z', \verb'_' &
    binary (infix) &
    right &
    4 \\
    \hline
    \verb'a'--\verb'z', \verb'A'--\verb'Z', \verb'_' &
    unary (prefix) &
    non-associative &
    3 \\
    \hline
  \end{tabular}
\end{center}
By allowing any name to be an operator, we avoid the need for a lot of
special syntax.  In particular, we want to allow the following forms:

\section{Modules}

Each source file is a module, whose name is taken from the file name.
Modules may contain any number of the
following things, in any order:
\begin{itemize}
\item Type definitions
\item (Sub-)modules
\item Module imports
\item Function definitions
\item Procedure definitions
\item Statements
\end{itemize}

A module may also be an operating system directory, in which case all
modules in that directory are taken to be its public submodules.  If
the directory contains a \lang source file with the same base name as
the directory, this overrides the public importation, allowing the
module to chose which submodules to export, as well as to define its
own top-level procedures, functions, and initialization statements.

\subsection{Exports}
Each type, submodule, function, and procedure definition may be
preceded with the modifier '\texttt{public}', in which case, that
element is exported.  Lacking such a modifier, it is private, and
cannot be used outside that module.


\subsection{Imports}
\Lang supports the following varieties of module importation:
\begin{itemize}
\item A full module may be imported (\texttt{use}
  \emph{module}), or only certain specified members
  may be imported (\texttt{from} \emph{module} \texttt{use}
  \emph{items}).
\item Members may be imported such that they become public members of
  the \emph{importing} module, visible to any module that imports it
  (by preceding the \texttt{use} directive with
  \texttt{public}) or not.
\end{itemize}
This gives the following four varieties of importation:
\begin{center}
  \begin{tabular}{|p{20mm}|p{90mm}|}
    \hline \raggedright
    \texttt{use} \emph{module}
    & Imports everything made public by \emph{module} so that it can be used
    with or without module qualification.
    \\ \hline \raggedright
    \texttt{from} \emph{module} \texttt{use} \emph{items}
    & Imports the specified items, which must all be made public
    by \emph{module}, so that they
    can be used with or without module qualification.
    \\ \hline \raggedright
    \texttt{public use} \emph{module}
    & Imports everything made public by \emph{module} so that it can be used
    with or without module qualification, and reexport it from the
    importing module as if it were defined there.
    \\ \hline \raggedright
    \texttt{public from} \emph{module} \texttt{use} \emph{items}
    & Imports the specified items, which must all be made public by
    \emph{module}, so that they
    can only be used with module qualification, and reexport
    them from the importing module as if they were defined there.
    \\ \hline
  \end{tabular}
\end{center}

\section{Types}

\Lang is strongly typed, with parametric polymorphism (generics),
type inference, and Liskov substitution.
All data types are effectively abstract data types.
That means that,
as in object oriented languages, any type may be ``extended'' by
another type, and instances of that other type my be used wherever
instances of the extended type can be.
This provides similar functionality to type classes, but without the
need to decide ahead which things should be types and which should be
type classes.
\Lang ensures that all programs follow Martin's dictum:
``Depend upon Abstractions. Do not depend upon concretions.''

The language also supports Myer's uniform access principle.
Every type is simply a module whose name may be used as a type name.
The primitive operations (methods) of the type are the operations
exported by the module.

Constructors (and deconstructors) are ordinary functions.
A type's constructors may be explicitly declared using the
\texttt{ctor} declaration.
This looks like a function declaration, except that the return type
and function body are omitted.
The compiler automatically generates the implementation of the
constructor and deconstructor functions.
However, constructors and deconstructors are ordinary functions, so
an existing type with defined constructors and deconstructors can be
redefined with new functions implementing the same interface as the
previous constructors and deconstructors.

Functions and procedures can be declared to be \texttt{abstract}, in
which case their implementations are omitted.
The compiler will not permit abstract operations to be invoked; the
value must be known to be of a subtype that implements the operation for
it to be used.

There is a type \texttt{data} that serves as the root of the hierarchy
of data types.  This type has several useful abstract operations such
as equality testing, and printing.  All types declared with
constructors, as well as all the primitive types such as integer,
float, and char, implement this type.

\section{Code Transformation}

\Lang code is transformed into deterministic clausal form as the
compiler's intermediate representation.
In this form, each procedure body is represented as a (possibly empty)
list of primitive operations (comprising the common initial operations
for all clauses), and optionally a variable on which to switch and a
list of procedure bodies.
The value of the variable then determines which (exactly one)
of the bodies is executed.

Each operation in a body may have any number of inputs and any number
of outputs, but not in/out variables.
Inputs may be either variables or manifest constants; outputs must
always be distinct fresh variables.
For convenience, variable names have an explicit ``version'' number
suffix, similar to the common variable naming scheme used in SSA
languages.


\end{document}

% LocalWords:  vararg predicate's nonfailure DCG monoporphized nondet RDBMS
% LocalWords:  coroutining distfix ness supertyping Liskov backquote
% LocalWords:  restrictable ctor
