# aliasing data structures in nested proc calls

use position
public proc replicate2(p1:position, ?p2:position) use !io
  ?pp = position(0,0)
  !print("random replicate2 ")
  !println(pp.x)
  ?p2 = p1
end

# Expected Alias Pairs: [(0,1),(0,2),(1,2)]
public proc replicate1(p1:position, ?p2:position, ?p3:position) use !io
  ?pp = position(0,0)
  !print("random replicate1 ")
  !println(pp.x)
  ?p2 = p1

  !replicate2(p1, ?p3)
end

public proc bar use !io
  ?p1 = position(101,102)
  !replicate1(p1, ?p2, ?p3)

  x(!p1, 555)
  !print("expect p1 is 555? ")
  !println(p1.x) # expected 555 - is 555
  !print("expect p2 is 101? ")
  !println(p2.x) # expected 101 - but is 555
  !print("expect p3 is 101? ")
  !println(p3.x) # expected 101 - but is 555
end

!bar